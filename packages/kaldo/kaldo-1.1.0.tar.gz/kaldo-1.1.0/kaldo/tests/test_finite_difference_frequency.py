import numpy as np
from ase.build import bulk
from ase.calculators.emt import EMT
from kaldo.forceconstants import ForceConstants
from kaldo.phonons import Phonons
import pytest
from tempfile import TemporaryDirectory

frequency = np.array(
    [
        [-1.25649072e-04, -8.34000390e-05, -3.59057257e-05],
        [1.97491784e00, 1.97491785e00, 4.42161612e00],
        [3.14745764e00, 3.14745765e00, 7.47699178e00],
        [3.14745764e00, 3.14745765e00, 7.47699178e00],
        [1.97491784e00, 1.97491785e00, 4.42161612e00],
        [1.97491785e00, 1.97491785e00, 4.42161612e00],
        [3.14904947e00, 3.14904947e00, 4.18064810e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [2.65294463e00, 4.59239797e00, 5.96657231e00],
        [3.14745764e00, 3.14745765e00, 7.47699178e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [5.03817448e00, 5.03817448e00, 7.48345258e00],
        [4.92046371e00, 6.09817578e00, 7.58799483e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [3.14745764e00, 3.14745765e00, 7.47699178e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.92046371e00, 6.09817578e00, 7.58799483e00],
        [5.03817448e00, 5.03817448e00, 7.48345258e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [1.97491785e00, 1.97491785e00, 4.42161612e00],
        [2.65294463e00, 4.59239797e00, 5.96657231e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.14904947e00, 3.14904947e00, 4.18064810e00],
        [1.97491785e00, 1.97491785e00, 4.42161612e00],
        [3.14904947e00, 3.14904947e00, 4.18064810e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [3.14904946e00, 3.14904947e00, 4.18064809e00],
        [1.97491784e00, 1.97491785e00, 4.42161612e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.92046371e00, 6.09817579e00, 7.58799483e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.14745764e00, 3.14745765e00, 7.47699178e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [5.03817448e00, 5.03817448e00, 7.48345258e00],
        [4.92046371e00, 6.09817578e00, 7.58799483e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [5.03817448e00, 5.03817448e00, 7.48345258e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.14745765e00, 3.14745765e00, 7.47699178e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.92046371e00, 6.09817579e00, 7.58799483e00],
        [4.92046371e00, 6.09817578e00, 7.58799483e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.92046371e00, 6.09817578e00, 7.58799483e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [3.14745764e00, 3.14745765e00, 7.47699178e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.92046371e00, 6.09817578e00, 7.58799483e00],
        [5.03817448e00, 5.03817448e00, 7.48345258e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.92046371e00, 6.09817578e00, 7.58799483e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.92046371e00, 6.09817578e00, 7.58799483e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [5.03817448e00, 5.03817448e00, 7.48345258e00],
        [4.92046371e00, 6.09817579e00, 7.58799483e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [3.14745765e00, 3.14745765e00, 7.47699178e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [1.97491785e00, 1.97491785e00, 4.42161612e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.14904947e00, 3.14904947e00, 4.18064810e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.92046371e00, 6.09817579e00, 7.58799483e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.77058454e00, 6.18436289e00, 7.12511829e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [3.14904946e00, 3.14904947e00, 4.18064809e00],
        [4.06983868e00, 4.35881352e00, 6.75710303e00],
        [3.83740093e00, 5.28122332e00, 7.52582925e00],
        [2.65294464e00, 4.59239797e00, 5.96657231e00],
        [1.97491784e00, 1.97491785e00, 4.42161612e00],
    ]
)


@pytest.fixture(scope="session")
def phonons():
    print("Preparing phonons object.")
    # Setup crystal and EMT calculator
    atoms = bulk("Al", "fcc", a=4.05)
    with TemporaryDirectory() as td:
        forceconstants = ForceConstants(atoms=atoms, supercell=[5, 5, 5], folder=td)

        forceconstants.second.calculate(calculator=EMT())
        is_classic = False
        phonons_config = {"kpts": [5, 5, 5], "is_classic": is_classic, "temperature": 300, "storage": "memory"}
        phonons = Phonons(forceconstants=forceconstants, **phonons_config)
        return phonons


def test_frequency_with_forceconstants(phonons):
    calculated_frequency = phonons.frequency
    np.testing.assert_equal(np.round(calculated_frequency - frequency, 2), 0)
