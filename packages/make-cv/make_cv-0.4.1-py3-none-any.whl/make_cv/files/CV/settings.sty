%%%%%%%%%%%%%%%
% This CV example/template is based on my own
% CV which I (lamely attempted) to clean up, so that
% it's less of an eyesore and easier for others to use.
%
% LianTze Lim (liantze@gmail.com)
% 23 Oct, 2022
% 24 Aug, 2024 -- added simpleicons to provide X-twitter icon

% Add folder to search path
\def\input@path{{Tables_cv/}}
%or: \def\input@path{{/path/to/folder/}{/path/to/other/folder/}}

\RequirePackage{silence}
\WarningsOff[longtable]
\WarningsOff[array]

\usepackage{ifxetex,ifluatex}
\newif\ifxetexorluatex
\ifxetex
  \xetexorluatextrue
\else
  \ifluatex
    \xetexorluatextrue
  \else
    \xetexorluatexfalse
  \fi
\fi

\RequirePackage{graphicx}
%\RequirePackage[hyphens]{url}
\RequirePackage{babel}
\RequirePackage{ltablex}
\RequirePackage{needspace}

\raggedright

% Make sure tables always span the page width
\keepXColumns
% Remove annoying line space before table
\setlength\LTpre{0in}

\RequirePackage[fixed]{fontawesome5}
%\RequirePackage{simpleicons}. Needed only if you want a X icon

\newcommand{\smallcaps}[1]{\textsc{\lowercase{#1}}}

\RequirePackage[nohead,nofoot,hmargin=2.25cm,vmargin=2cm]{geometry}
% Change the page margins if you want
% \geometry{left=1cm,right=1cm,top=1.5cm,bottom=1.5cm}

\RequirePackage{relsize}
\RequirePackage[dvipsnames,svgnames]{xcolor}
\RequirePackage{tikz}
%\RequirePackage{bookmark}
\usetikzlibrary{shapes,shadows}



\definecolor{SwishLineColour}{HTML}{88AC0B}
\definecolor{MarkerColour}{HTML}{B6073F}
% Change the colours if you want
% \definecolor{SwishLineColour}{HTML}{00FFFF}
% \definecolor{MarkerColour}{HTML}{0000CC}

% If you're not a researcher nor an academic, you probably don't need biblatex; delete this line.
\RequirePackage{biblatex}
\RequirePackage{csquotes}



% Redefine makerubric command to add bookmarks
\newcounter{BookmarkCounter}
\renewcommand*{\theBookmarkCounter}{\the\value{BookmarkCounter}}

% Create the colored circle numbering command
\RequirePackage{tikz}
\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
   \node[shape=circle,text=white,fill=MarkerColour!80!black,font=\sffamily\scriptsize\bfseries,inner sep=1pt,text height=1.35ex,minimum width=1.5em,text centered] (char) {#1};}}
 
 \newcommand*\squared[1]{\tikz[baseline=(char.base)]{
   \node[shape=circle,text=white,fill=MarkerColour!80!black,font=\sffamily\scriptsize\bfseries,inner sep=1pt,text height=1.15ex,minimum width=1.5em,text centered] (char) {#1};}}
   
   
 % If you need to further customise your biblatex setup e.g. with \DeclareFieldFormat etc please add them here AFTER loading settings.sty. For example, to remove the default "[Online] Available:" prefix before URLs when using the IEEE style:
\DefineBibliographyStrings{english}{url={\textsc{url}}}

  % Implement the colored circle in the bibliography
\newcounter{bibitem}
\AtBeginBibliography{\setcounter{bibitem}{1}}
\iffieldformatundef{labelnumberwidth}{%
  % if author-year style
  \AtEveryBibitem{\makebox[2.5em][l]{\circled{\thebibitem}\stepcounter{bibitem}}}%
}{%
  % if numeric style
  \DeclareFieldFormat{labelnumberwidth}{\makebox[2.5em][l]{\circled{\thebibitem}}}%
  \setlength{\biblabelsep}{0pt}%
  \AtEveryBibitem{\stepcounter{bibitem}}%
}
\AtEveryBibitem{\iffieldundef{doi}{}{\clearfield{url}}}

% Put the little doi icon in the bibliography
% \renewcommand{\bibfont}{\small}
\setlength{\bibitemsep}{1.5ex}
\setlength{\bibhang}{2.5em}
\RequirePackage{xpatch}
\xpretofieldformat{doi}
  {\textcolor{MarkerColour!80!black}{\scriptsize\faLink}}
  {}{}
\xpretofieldformat{url}
  {\textcolor{MarkerColour!80!black}{\scriptsize\faLink}}
  {}{}

% Implement the rubric style font & spacing
\headerscale{1}
%\setlength{\headerspace}{6pt}
\rubricfont{\Large\bfseries\sffamily}
\setlength{\rubricspace}{2pt}
%\setlength{\rubricafterspace}{-9pt}
\setlength{\rubricafterspace}{-3pt}
\setlength{\subrubricspace}{0pt}
\setlength{\subrubricbeforespace}{4pt}
\def\@@rubrichead#1{%
  \begin{tikzpicture}[baseline]%\
  \shade[left color=SwishLineColour!60!white, right color=white] rectangle (\@almosttextwidth,2.5pt);
  \node[font={\@rubricfont},inner sep=0pt,text ragged,anchor=south west,text depth=.5ex,text height=1.5ex] at (1pt,2pt) {#1};
  \end{tikzpicture}%
  \vspace\rubricspace%
}



\subrubricfont{\large\bfseries\sffamily}
\subrubricalignment{l}

% Convenicence command to make the links in the header
\newcommand{\makefield}[2]{\makebox[1.5em]{\color{MarkerColour!80!black}#1} #2}

\keyalignment{r}
\rubricalignment{l}
\renewcommand{\arraystretch}{1.25}
\urlstyle{tt}

\newcommand{\prefixmarker}[1]{\def\@prefixmarker{#1}}
\def\@prefixmarker{\relscale{.9}\faBookmark}
% Change the item prefix marker if you want
% \prefixmarker{$\diamond$}

\prefix{%
  \hspace*{-1ex}
  \color{MarkerColour!80!black}\@prefixmarker%
  \hspace*{1ex}%
}

% in case someone wants to use the itemize environment
\renewcommand{\labelitemi}{\tikz\draw[MarkerColour!80!black,fill=MarkerColour!80!black] (0,0) circle (0.75ex);}

% Command to print rubric head (original)
\newcommand{\makerubrichead}[1]{
\stepcounter{BookmarkCounter}%
\pdfbookmark[-1]{#1}{note\theBookmarkCounter} %
\needspace{4\baselineskip}
\vskip\baselineskip\@@rubrichead{#1} }
% Revised version that works with tabularx

\newcommand{\conthead}[1]{
  \begin{tikzpicture}[baseline]%\
  \shade[left color=SwishLineColour!60!white, right color=white] rectangle (\@almosttextwidth,2.5pt);
  \node[font={\@rubricfont},inner sep=0pt,text ragged,anchor=south west,text depth=.5ex,text height=1.5ex] at (1pt,2pt) {#1\@continuedname};
  \end{tikzpicture}%
  \vspace\rubricspace%
}

\defbibheading{subbibliography}{\vskip\subrubricbeforespace{\@subrubricfont\hspace{3pt}#1}\par}
\defbibfilter{booksandchapters}{%
( type=book or type=incollection )
}

% Modifications to allow bolding of names
\RequirePackage{pgffor}
\newcommand{\mynames}[1]{\def\my@namelist{#1}}
\newtoggle{boldname}
\renewcommand*{\mkbibnamefamily}[1]{%
  \global\togglefalse{boldname}%
  \foreach \my@fname / \my@gname in \my@namelist {%
    \ifboolexpr{ test {\ifdefstrequal{\namepartfamily}{\my@fname}}
                 and
                 test {\ifdefstrequal{\namepartgiven}{\my@gname}}}
      {\global\toggletrue{boldname}}{}%
  }%
  \iftoggle{boldname}{\textbf{#1}}{#1}%
}

\renewcommand*{\mkbibnamegiven}[1]{%
  \global\togglefalse{boldname}%
  \foreach \my@fname / \my@gname in \my@namelist{%
    \ifboolexpr{ test {\ifdefstrequal{\namepartfamily}{\my@fname}}
                 and
                 test {\ifdefstrequal{\namepartgiven}{\my@gname}}}
      {\global\toggletrue{boldname}\breakforeach}{}%
  }%
  \iftoggle{boldname}{\textbf{#1} }{#1}%
}

% I link the links to be blue so people know they are links
\RequirePackage[colorlinks=true,allcolors=blue,breaklinks=true]{hyperref}

% All of this if logic is to avoid the problem of the heading get moved to the next page and doubling up with the continued heading
% From https://tex.stackexchange.com/questions/148043/how-to-generate-a-section-continued-heading-after-page-break?noredirect=1&lq=1
% This doesn't really work correctly, but it's better than nothing....
% Longtable is clearly doing something smarter, but I haven't figured that out.
\newif\if@bibpage %Conditional to see if we are on the page where a bibliography has been started
\newif\if@bibhead@pagebreak %Conditional to check if a adding header will cause a pagebreak
\newdimen\neededheight
\newdimen\pt@saved
% Modification to bibtex to allow headers on continued pages
\defbibheading{contbibnumbered}{%
 \neededheight=15\baselineskip
 \pt@saved=\the\pagetotal% store the current pagetotal value
 \advance\pt@saved by \neededheight
 \ifdim\pt@saved>\pagegoal% the tabular will cause a pagebreak
    \global\@bibhead@pagebreaktrue
  \fi
 \@bibpagetrue
 \message{neededheight =\the\neededheight\space ptsaved=\the\pt@saved \space pagegoal=\the\pagegoal \space \if@bibhead@pagebreak{TRUE}\else{FALSE}\fi}
 \needspace{4\baselineskip}
 \stepcounter{BookmarkCounter}%
 \pdfbookmark[0]{#1}{note\theBookmarkCounter} %
 \vskip\subrubricbeforespace{\@subrubricfont\hspace{3pt}#1}%
  \gdef\@cont@heading{%
    \if@twocolumn
        \@topnewpage[\@subrubricfont\hspace{3pt}#1\@continuedname\par]%
      \else
      	\@subrubricfont\hspace{3pt}#1\@continuedname\par%
      \fi
      \@afterheading
  }
  \AddToHook{shipout/before}[myhook]{%
    \if@bibpage
      \if@bibhead@pagebreak\else\aftergroup\@cont@heading\fi
    \else
     \aftergroup\@cont@heading
    \fi
  \global\@bibpagefalse
  \global\@bibhead@pagebreakfalse}
  }

% Cleanup to removed header
\def\blx@endbibliography{%
  \csuse{blx@endenv@\blx@theenv}%
  \RemoveFromHook {shipout/before} [myhook]
  \blx@noitem
  \endgroup
  \blx@bibnote\blx@thepostnote
  \endgroup}

% Avoid breaking of references across pages
\usepackage{etoolbox}  % <============================ to patch penaltys
\patchcmd{\thebibliography}{\clubpenalty4000}{\clubpenalty10000}{}{}     % no orphans
\patchcmd{\thebibliography}{\widowpenalty4000}{\widowpenalty10000}{}{}   % no widows
\patchcmd{\bibsetup}{\interlinepenalty=5000}{\interlinepenalty=10000}{}{} % no break of entry

%\stepcounter{BookmarkCounter}
%\pdfbookmark[-1]{#1}{note\theBookmarkCounter}

% This adds the field citations to the bibliography data so I can add the number of citaitons
\begin{filecontents}{biblatex-dm.cfg}
\DeclareDatamodelFields[type=field, datatype=integer, nullok=true]{citations}
\DeclareDatamodelEntryfields{citations}
\end{filecontents}

\renewbibmacro*{finentry}{
\printfield{citations}%
\finentry}
\DeclareFieldFormat{citations}{\mkbibbrackets{#1}}

% Row counter for tabularx enrvironment
\newcounter{rowcnt}
\newcommand\rownum{\ifnumequal{\value{rowcnt}}{0}{}{\squared{\therowcnt}}\stepcounter{rowcnt}}
\AtEndEnvironment{tabularx}{\setcounter{rowcnt}{0}}

% command to label students in bibliography
\providecommand{\us}{\textsuperscript{*}}
\providecommand{\gs}{\textsuperscript{+}}

%% Remove some fields from journal articles
%\AtEveryCitekey{\ifentrytype{article}{\clearfield{url}\clearfield{issn}\clearfield{review}\clearfield{series}\clearfield{eprint}}{}}
%\AtEveryCitekey{\ifentrytype{misc}{\clearfield{url}\clearfield{issn}\clearfield{review}\clearfield{series}\clearfield{eprint}}{}}
%\renewbibmacro*{url+urldate}{}
%\renewbibmacro*{eprint}{}

\newboolean{usePhoto}
\setboolean{usePhoto}{false}

% Change the fonts if you want
\ifxetexorluatex % If you're using XeLaTeX or LuaLaTeX
  \usepackage{fontspec} 
  %% You can use \setmainfont etc; I'm just using these font packages here because they provide OpenType fonts for use by XeLaTeX/LuaLaTeX anyway
  %\usepackage[p,osf,swashQ]{cochineal}
  \usepackage[medium,bold]{cabin}
  \usepackage[varqu,varl,scale=0.9]{zi4}
\else % If you're using pdfLaTeX or latex
  \usepackage[T1]{fontenc}
  \usepackage[p,osf,swashQ]{cochineal}
  \usepackage{cabin}
  \usepackage[varqu,varl,scale=0.9]{zi4}
\fi



\newboolean{Journal}
\newboolean{Refereed}
\newboolean{Book}
\newboolean{Conference}
\newboolean{Patent}
\newboolean{Invited}
\newboolean{PersonalAwards}
\newboolean{StudentAwards}
\newboolean{Service}
\newboolean{Reviews}
\newboolean{GradAdvisees}
\newboolean{UndergradResearch}
\newboolean{Teaching}
\newboolean{Grants}
\newboolean{Proposals}

\setboolean{Journal}{true}
\setboolean{Refereed}{true}
\setboolean{Book}{true}
\setboolean{Conference}{true}
\setboolean{Patent}{true}
\setboolean{Invited}{true}
\setboolean{PersonalAwards}{true}
\setboolean{StudentAwards}{true}
\setboolean{Service}{true}
\setboolean{Reviews}{true}
\setboolean{GradAdvisees}{true}
\setboolean{UndergradResearch}{true}
\setboolean{Teaching}{true}
\setboolean{Grants}{true}
\setboolean{Proposals}{true}

\IfFileExists{exclusions.tex} {
\input{exclusions.tex}
}




