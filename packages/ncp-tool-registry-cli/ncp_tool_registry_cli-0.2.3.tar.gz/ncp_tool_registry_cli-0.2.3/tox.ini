[tox]
envlist = py{311}, coverage, style

[testenv]
passenv =
    BUILD*
    EC2*
    JENKINS*
    NETFLIX*
    WORKSPACE
setenv = COVERAGE_FILE={toxworkdir}/.coverage.{envname}
usedevelop = True
deps = -rrequirements.txt
       -rtests/requirements.txt
commands = pytest {posargs:-vv --junit-xml="{toxworkdir}/junit.{envname}.xml" --cov=src/ tests/}

[testenv:coverage]
setenv = COVERAGE_FILE={toxworkdir}/.coverage
skip_install = True
deps = coverage
commands = coverage combine
           coverage html
           coverage xml
           coverage report -m

[testenv:style]
skip_install = True
deps = ruff
commands = ruff check
           ruff format --diff

[testenv:stylefix]
skip_install = True
deps = ruff
commands = ruff check --fix
           ruff format

# Stage package in {envdir}/root, this is for debian-like packaging
[testenv:package]
changedir = {envdir}
skip_install = True
skipsdist = True
deps = pickley
commands = pickley package "{toxinidir}" -droot/apps -sroot:root/usr/local/bin

[coverage:xml]
output = .tox/test-reports/coverage.xml
[coverage:html]
directory = .tox/test-reports/htmlcov

[pytest]
cache_dir = .tox/.cache

[tool:pytest]
markers =
    unit: mark test as a unit test
    integration: mark test as an integration test
