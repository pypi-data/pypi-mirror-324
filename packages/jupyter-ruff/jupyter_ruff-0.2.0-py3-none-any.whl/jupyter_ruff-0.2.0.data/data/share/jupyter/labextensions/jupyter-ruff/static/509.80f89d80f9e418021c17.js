"use strict";(self.webpackChunkjupyter_ruff=self.webpackChunkjupyter_ruff||[]).push([[509],{509:(e,t,o)=>{o.r(t),o.d(t,{default:()=>h});var n=o(209),r=o(123),c=o(593),s=o(310),i=o(920),a=o.n(i),l=o(259);class u{indices;constructor(e){this.indices=[];const t=e.split("\n");let o=0;for(const e of t)o+=e.length+1,this.indices.push(o)}maxPosition(){return this.indices.at(this.indices.length-1)??0}convert(e,t){const[o,n]=[e-1,t-1];return(o>0?this.indices[o-1]:0)+n}}function f(e,t){return null!==e.currentWidget&&e.currentWidget===t.currentWidget}function d(e){return"code"===e?.type&&"text/x-ipython"===e?.mimeType}async function m(e,t,o){let n=t.context.path;do{n=s.PathExt.dirname(n);const t=await e.serviceManager.contents.get(n).then((e=>e.content));for(const n of[".ruff.toml","ruff.toml","pyproject.toml"]){const r=t.find((e=>e.name===n));if(void 0===r)continue;const c=await e.serviceManager.contents.get(r.path),s=l.parse(c.content);if("pyproject.toml"!==n)return new i.Workspace({...s,...o});if(void 0!==p(s))return new i.Workspace({...s,...o})}}while(""!==n);return new i.Workspace(o)}function p(e){return e.tool instanceof Object&&e.tool.ruff}const h={id:"jupyter-ruff:plugin",description:"A JupyterLab and Jupyter Notebook extension for formatting code with Ruff.",autoStart:!0,requires:[n.ICommandPalette,r.INotebookTracker,c.ISettingRegistry],activate:async(e,t,o,n)=>{await a()();const c=await n.load("jupyter-ruff:plugin");let[s,l,p]=[c.get("format-on-run").composite,c.get("format-on-save").composite,c.get("sort-imports").composite];c.changed.connect(((e,t)=>{[s,l,p]=[e.get("format-on-run").composite,e.get("format-on-save").composite,e.get("sort-imports").composite]}));const h={select:["I"]};let g=new i.Workspace(h);function y(e){const t=p?function(e,t){let o;try{o=e.check(t)}catch{return t}return function(e,t){const o=new u(e);let n=o.maxPosition();const r=[];for(const c of t.reverse())for(const t of c.fix?.edits.reverse()??[]){const[c,s]=[o.convert(t.location.row,t.location.column),o.convert(t.end_location.row,t.end_location.column)];r.push(e.slice(s,n)),r.push(t.content),n=c}return r.push(e.slice(0,n)),r.reverse().join("")}(t,o)}(g,e):e;return function(e,t){try{return e.format(t).trimEnd()}catch{return t}}(g,t)}o.currentChanged.connect((async(t,o)=>{g=await m(e,o,h)})),e.commands.addCommand("jupyter-ruff:format-cell",{label:"Format Cell Using Ruff",isEnabled:()=>f(o,e.shell)&&d(o.activeCell?.model),isVisible:()=>!0,execute:function(e){const t=y(o.activeCell.model.sharedModel.source);o.activeCell?.model.sharedModel.setSource(t)}}),e.commands.addCommand("jupyter-ruff:format-all-cells",{label:"Format All Cells Using Ruff",isEnabled:()=>f(o,e.shell),isVisible:()=>!0,execute:function(e){const t=o.currentWidget?.content.model?.cells??[];for(const e of t){if(!d(e))continue;const t=y(e.sharedModel.source);e.sharedModel.setSource(t)}}}),e.commands.addCommand("jupyter-ruff:reload-configuration",{label:"Reload Configuration Files for Ruff",isEnabled:()=>!0,isVisible:()=>!0,execute:async function(t){g=await m(e,o.currentWidget,h)}}),t.addItem({command:"jupyter-ruff:format-cell",category:"ruff"}),t.addItem({command:"jupyter-ruff:format-all-cells",category:"ruff"}),t.addItem({command:"jupyter-ruff:reload-configuration",category:"ruff"}),r.NotebookActions.executionScheduled.connect(((e,{cell:t})=>{if(d(t.model)&&s){const e=y(t.model.sharedModel.source);t.model.sharedModel.setSource(e)}})),o.currentChanged.connect((async(e,t)=>{t?.context.saveState.connect(((e,t)=>{if("started"===t&&l)for(const t of e.model.cells){if(!d(t))continue;const e=y(t.sharedModel.source);t.sharedModel.setSource(e)}}))}))}}}}]);